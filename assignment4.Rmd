---
title: "Assignment 4"
author: "Rory Sarten 301005654"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    pandoc_args: "--highlight-style=breezeDark"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
```

## Question 1

a)

```{r Q1_a}
food_prices <- readr::read_delim("food_prices_kg2019.csv", delim = ",", col_types = readr::cols())
theta_est <- IQR(food_prices$Data_value) %>% round(3)
theta_est
```

b)

```{r Q1_b}
set.seed(1)
N <- 1e4
boot_IQR <- 1:N %>% 
  lapply(function(i) sample(food_prices$Data_value, replace = TRUE)) %>% 
  sapply(IQR) %>% 
  round(3)

## standard error of estimator
sd(boot_IQR) %>% round(3)

## standard 95% bootstrap confidence interval
(theta_est + 1.96*c(-1, 1)*sd(boot_IQR)) %>% round(3)
```

c)

```{r Q1_c}
## Efron's interval
quantile(boot_IQR, probs = c(0.025, 0.975)) %>% round(3)
```

d)

```{r Q1_d}
## Hall's interval
hall <- (2 * theta_est - quantile(boot_IQR, probs = c(0.975, 0.025))) %>% round(3)
names(hall) <- c("2.5%", "97.5%")
hall
```

e)

```{r Q1_e}
## bias
bias <- (mean(boot_IQR) - theta_est) %>% round(3)
bias

## size of bias in relation to the std error
bias_size <- (bias/sd(boot_IQR)) %>% round(3)
bias_size
```

The bias is approximately `r round(bias_size * 100, digits = 0)`% of the $s.e.(\hat\theta)$. The size of this bias is considerable.

f)

```{r Q1_f}
## bias corrected Efron interval
(quantile(boot_IQR, probs = c(0.025, 0.975)) - bias) %>% round(3)
```

The lower bound of the confidence interval is above $4. We reject the hypothesis that the test IQR could be below 4NZD at the 5% confidenc interval.

## Question 2

a)

1. Calculate the observed $\hat\beta$ and $\hat\sigma^2$ from the observed data
2. Draw a sample of the observations with replacement and calculate a new estimate $\hat\beta^*_b$ from the sample
3. Repeat step 2 $N$ times
4. Calculate $s.e.(\hat\beta^*)$ as the standard error over the results of the bootstrapped samples
5. Calculate $\hat\beta \pm1.96\times s.e.(\hat\beta^*)$ (for 95% confidence interval)

b)

```{r Q2_b}
galaxy <- readr::read_delim("galaxies.csv", delim = ",", col_types = readr::cols())
velocity <- galaxy$v %>% as.numeric()
distance <- galaxy$d %>% as.numeric()

############################################
## Calculations
calc_beta <- function(v, d) sum(v)/sum(d)

calc_sigma <- function(v, d) {
  beta_est <- calc_beta(v, d)
  mean(1/d*(v - beta_est*d)^2)
}
############################################

n <- length(distance)
beta_est <- calc_beta(velocity, distance)
sigma_est <- calc_sigma(velocity, distance)

N <- 1e4
set.seed(-1)
bootstrap_velocity <- 1:N %>% 
  lapply(function(i) {
    beta_est*distance + rnorm(n, sd = sqrt(sigma_est * distance))})

bootstrap_beta <- bootstrap_velocity %>% 
  sapply(calc_beta, distance)

estimate <- mean(bootstrap_beta)
ci <- beta_est + 1.96 * c(-1, 1) * sd(bootstrap_beta)

results <- c(estimate, ci) %>% round(3)
names(results) <- c("Estimate", "Lower", "Upper")
results
```